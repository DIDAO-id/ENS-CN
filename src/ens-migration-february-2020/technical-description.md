# 技术说明

最近，我们发现ENS注册表合约中存在漏洞。此漏洞将使域所有者可以设置“后门”，以便他们可以将域转让或出售给另一个用户并在之后未经新所有者同意收回该域的所有权。

此漏洞的性质是攻击者必须在某一时刻拥有相关域的合法所有权，并且他们必须在放弃名称所有权之前设置此“后门”。因此，此漏洞无法被追溯利用。

Sam Sun通过以太坊基金会的漏洞赏金流程报告了此漏洞。我们详细检查了ENS注册表，并确信之前没有人利用过此漏洞。因此，所有ENS名称的所有权都是安全的。

因此，ENS正在迁移到新的部署。本文档描述了正在采取的确切技术步骤，以及它们对DApp作者和用户的影响的简要说明。

本文档旨在为任何对迁移的底层细节感兴趣的人提供详细的描述。对于大多数用户或开发人员而言，理解这一点不是必需的；有关漏洞的描述及其对用户的影响，请参阅我们的[Medium发布](https://medium.com/the-ethereum-name-service/ens-registry-migration-bug-fix-new-features-64379193a5a)；有关开发人员迁移步骤的说明，请参阅[DApp开发人员指南](ens-migration-february-2020/guide-for-dapp-developers.md)。

## 新的ENS部署

大多数ENS合约的新实例正在部署中。其中一些发生了变化，而另一些正在重新部署，以引用新注册表而不是旧注册表。

### ENS注册表

新版本的ENS注册表已经部署，可以在地址`0x00000000000C2E074eC69A0dFb2997BA6C7d2e1e`找到。除了修复漏洞，我们还借此机会实现了一些额外的功能，这些功能将提高ENS的可用性：

* 添加`setRecord`和`setSubnodeRecord`方法，允许在单个操作中设置所有者、解析器和TTL。

* 添加基于ERC721的批准机制，允许用户将其名称的控制权委托给另一个地址，而无需转移他们的名称。

新的注册表实施已经过[Sam Sun的审计](https://gist.github.com/samczsun/2f0a2e266191042baada48c5407d8986)，并由Consensys Diligence审查过；两位审计员都没有发现任何问题。

为了使迁移尽可能顺利，新注册中心配置了回退；如果在自己的存储中找不到记录，它将在之前的ENS注册合约中查找。此回退仅适用于读取操作；如果一条记录存在于旧注册表中但不存在于新注册表中，则用户无法调用函数来修改新注册表中的该记录。

这意味着要从以前的注册表迁移每个名称，必须像从头开始一样重新创建名称—因此，例如，如果新注册表中尚不存在“foo.eth”，则“eth”的所有者必须通过调用 setSubnodeOwner（或新的

setSubnodeRecord），以与新域相同的方式创建它。其他顶级域所有者（例如，.luxe、.kred、.club和 .art）将需要代表他们的用户执行此操作，以便这些用户可以恢复对其域的写入权限。



### .ETH注册商

### 迁移合约

### 公共解析器

### 反向注册商

### DNSSEC注册商

### 子域名注册商
